<%@page import="java.io.DataInputStream"%>
<%@page import="java.io.FileInputStream"%>
<%@page import="java.io.File"%>
<%
         if(request.getParameter("file")!=null)
        {
             String context = request.getContextPath();
             
            int BUFSIZE = 4096;
            String docsPath = getServletContext().getRealPath("/docs") + "/";
            String filePath = new File(docsPath + request.getParameter("file")).getCanonicalPath();

            if (filePath.startsWith(docsPath)) {
                File file = new File(filePath);
                int length   = 0;
                ServletOutputStream outStream = response.getOutputStream();
                response.setContentType("text/html");
                response.setContentLength((int)file.length());
                response.setHeader("Content-Disposition", "attachment; filename=\"" + file.getName() + "\"");

                byte[] byteBuffer = new byte[BUFSIZE];
                DataInputStream in = new DataInputStream(new FileInputStream(file));

                while ((in != null) && ((length = in.read(byteBuffer)) != -1))
                {
                outStream.write(byteBuffer,0,length);
                }

                in.close();
                outStream.close();
            }
            else {
                // TODO Better error handling
                out.print("premission denied");
            }
        }
        else
        {
    %>
     <%@ include file="/header.jsp" %>
 <h3> Download Files: </h3><br/>
 <ul>
     <li><a href="download.jsp?file=doc1.pdf"> Doc1.pdf </a>  </li>
    <li><a href="download.jsp?file=exampledoc.pdf"> ExampleDoc.pdf </a></li>
 </ul>
     
  <%@ include file="/footer.jsp" %>
  <%
        }
        %>
