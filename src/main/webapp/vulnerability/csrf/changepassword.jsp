<%@include file="/header.jsp" %>
<%@page import="java.sql.Connection"%>
<%@page import="java.sql.PreparedStatement"%>
<%@page import="java.sql.SQLException"%>

<%@page import="java.sql.ResultSetMetaData"%>
<%@page import="java.sql.ResultSet"%>
<%@page import="java.util.*,java.io.*"%>
<%@page import="org.cysecurity.cspf.jvl.model.DBConnect"%>

<%
	if(session.getAttribute("isLoggedIn")!=null)
	{
		String id=session.getAttribute("userid").toString();
%>
Enter the New Password: <br/><br/>
<form action="changepassword.jsp" method="POST">
	<table>
		<tr>
			<td>New Password:</td>
			<td><input type="text" name="password" value=""/></td>
		</tr>
		<tr>
			<td>Confirm Password: </td>
			<td><input type="text" name="confirmpassword" value=""/></td>
		</tr>
		<tr>
			<td></td>
			<td><input type="submit" name="change" value="Change"/></td>
		</tr>
	</table>
</form>
<br/>
<%
		Connection con = new DBConnect().connect(
			getServletContext().getRealPath("/WEB-INF/config.properties")
		);

		String action=request.getParameter("change");
		if (action != null)
		{
			String pass=request.getParameter("password");
			String confirmPass=request.getParameter("confirmpassword");
			if(pass != null && confirmPass != null && !pass.equals(""))
			{
				if (pass.equals(confirmPass))
				{
					PreparedStatement stmt = con.prepareStatement(
						"Update users set password=? where id=?"
					);
					stmt.setString(1, pass);
					stmt.setString(2, id);
					stmt.executeUpdate();
					out.print("<b class='success'>Password Changed</b>");
					out.print("<br/><br/><b><a href='changepassword.jsp'>Return to the Previous page </a></b>");
				}
				else
				{
					 out.print("Passwords didn't match");
				}
			}
			else
			{
				out.print("Password can't be empty");
			}
		}
	}
%>

<!-- CSRF	-->
<!-- Insecure Direct Object Reference 2 -->

 <%@ include file="/footer.jsp" %>