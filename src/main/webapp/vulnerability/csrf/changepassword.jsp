<%@include file="/header.jsp" %>
<%@page import="java.sql.Connection"%>
<%@page import="java.sql.PreparedStatement"%>
<%@page import="java.sql.SQLException"%>

<%@page import="java.sql.ResultSetMetaData"%>
<%@page import="java.sql.ResultSet"%>
<%@page import="java.util.*,java.io.*"%>
<%@page import="org.cysecurity.cspf.jvl.model.DBConnect"%>
<%@page import="org.cysecurity.cspf.jvl.model.HashMe"%>

<%
	if(session.getAttribute("isLoggedIn")!=null)
	{
%>
Enter the New Password: <br/><br/>
<form action="changepassword.jsp" method="POST">
	<table>
		<tr>
			<td>Old Password:</td>
			<td><input type="password" name="oldpassword" value=""/></td>
		</tr>
		<tr>
			<td>New Password:</td>
			<td><input type="password" name="password" value=""/></td>
		</tr>
		<tr>
			<td>Confirm Password: </td>
			<td><input type="password" name="confirmpassword" value=""/></td>
		</tr>
		<tr>
			<td></td>
			<td><input type="submit" name="change" value="Change"/></td>
		</tr>
	</table>
</form>
<br/>
<%
		Connection con = new DBConnect().connect(
			getServletContext().getRealPath("/WEB-INF/config.properties")
		);

		String action=request.getParameter("change");
		if (action != null)
		{
			String oldPassword = request.getParameter("oldpassword");
			String pass = request.getParameter("password");
			String confirmPass = request.getParameter("confirmpassword");
			if(pass != null && confirmPass != null && !pass.equals(""))
			{
				if (pass.equals(confirmPass))
				{
					int id = (Integer)session.getAttribute("userid");

					PreparedStatement stmt1 = con.prepareStatement(
						"SELECT password, salt FROM users where id=?"
					);
					stmt1.setInt(1, id);

					ResultSet rs1 = stmt1.executeQuery();
					if (rs1.next()) {
						String salt = rs1.getString("salt");
						if (rs1.getString("password").equals(HashMe.hashMe(oldPassword, salt))) {
							PreparedStatement stmt2 = con.prepareStatement(
								"UPDATE users SET password=? where id=?"
							);
							stmt2.setString(1, HashMe.hashMe(pass, salt));
							stmt2.setInt(2, id);
							stmt2.executeUpdate();
							out.print("<b class='success'>Password Changed</b>");
							out.print("<br/><br/><b><a href='changepassword.jsp'>Return to the Previous page </a></b>");
						}
						else {
							out.print("Old password is incorrect");
						}
					}
					else {
						out.print("Something went wrong");
					}
				}
				else
				{
					 out.print("Passwords didn't match");
				}
			}
			else
			{
				out.print("Password can't be empty");
			}
		}
	}
%>

<!-- CSRF	-->
<!-- Insecure Direct Object Reference 2 -->

 <%@ include file="/footer.jsp" %>
